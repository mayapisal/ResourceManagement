<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ResourceProvider dApp</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
<style>
  :root { --bg:#f8f9fa; --card:#f8f9fa; --muted:#222; --accent:#5a2d82; --text:#e5e7eb; --danger:#ef4444; --ok:#10b981; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1,h2{margin:0 0 .5rem} h1{font-size:1.4rem} h2{font-size:1.1rem;color:var(--accent)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .grid{display:grid;gap:16px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  label{display:block;font-size:.85rem;color:var(--muted);margin:.5rem 0 .25rem}
  input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:var(--text)}
  input::placeholder{color:#f8f9fa} textarea{min-height:90px}
  button{cursor:pointer;background:#0ea5e9;border-color:#0ea5e9;font-weight:600}
  button.secondary{background:#111827;border-color:#374151}
  button.warn{background:var(--danger);border-color:var(--danger)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
    color: #000;
    background: #fff;
  }
  th, td {
    border: 1px solid #000;
    padding: 8px 10px;
    text-align: left;
    font-size: .92rem;
    background: #fff;
  }
  .hint{color:var(--muted);font-size:.85rem}
  .ok{color:var(--ok)} .bad{color:var(--danger)}
  .status{white-space:pre-wrap;background:#0b1220;border:1px dashed #1f2937;padding:10px;border-radius:12px;margin-top:10px;color:#cbd5e1}
  .foot{margin-top:24px;color:#222;font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <div class="grid g2">
    <div class="card">
      <h1>ResourceProvider</h1>
      <div class="row">
        <button id="btnConnect">üîå Connect Wallet</button>
        <button class="secondary" id="btnCheckRole">Check My Role</button>
      </div>
      <div id="whoami" class="hint" style="margin-top:8px"></div>
      <div id="network" class="hint"></div>
      <div id="formState" class="hint"></div>
      <div class="status" id="statusBox"></div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnMyRes">My Resources</button>
      </div>
      <div id="myResTable"></div>
      <div class="row" style="margin-top:10px">
        <button id="btnChkCompliance">Check Compliance (7 days)</button>
      </div>
      <pre class="status" id="complianceBox"></pre>
    </div>
  </div>

  <div class="grid g2" style="margin-top:16px">
    <div class="card">
      <h2>Set Resource Quantity</h2>
      <div class="row">
        <div>
          <label>Resource Type</label>
          <select id="setResType">
            <option value="0">Water</option>
            <option value="1">Food</option>
            <option value="2">Medical</option>
            <option value="3">Cloths</option>
          </select>
        </div>
        <div>
          <label>Quantity</label>
          <input id="setQty" type="number" min="0" placeholder="e.g., 50" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSet">Set Quantity</button>
      </div>
      <div class="hint">Allowed once per resource. Max: Water 200, Food 150, Medical 100, Cloths 150.</div>
    </div>

    <div class="card">
      <h2>Update Resource Quantity</h2>
      <div class="row">
        <div>
          <label>Resource Type</label>
          <select id="updResType">
            <option value="0">Water</option>
            <option value="1">Food</option>
            <option value="2">Medical</option>
            <option value="3">Cloths</option>
          </select>
        </div>
        <div>
          <label>New Quantity</label>
          <input id="updQty" type="number" min="0" placeholder="e.g., 25 (added or set)" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnUpdate">Update Quantity</button>
      </div>
      <div class="hint">If you already set a resource, this updates it and refreshes its updatedAt.</div>
    </div>
  </div>

  <!-- üîπ ADMIN / OWNER ONLY SECTION -->
  <div id="adminSection" style="display:none">
    <div class="grid g2" style="margin-top:16px">
      <div class="card">
        <h2>Admin/Owner: Form Controls</h2>
        <div class="row">
          <button id="btnOpen">Open Form</button>
          <button class="warn" id="btnClose">Close Form</button>
        </div>
      </div>

      <div class="card">
        <h2>Admin/Owner: View Supplier by ID</h2>
        <div class="row">
          <div>
            <label>Supplier ID</label>
            <input id="viewId" type="number" min="1" placeholder="e.g., 1" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnViewById">View Details</button>
        </div>
        <div id="viewByIdTable" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="grid g2" style="margin-top:16px">
      <div class="card">
        <h2>Admin/Owner: Suppliers by Resource Type</h2>
        <div class="row">
          <div>
            <label>Resource Type</label>
            <select id="byType">
              <option value="0">Water</option>
              <option value="1">Food</option>
              <option value="2">Medical</option>
              <option value="3">Cloths</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnByType">View</button>
        </div>
        <div id="byTypeTable"></div>
      </div>

      <div class="card">
      <h2>Admin/Owner: Supplier Matrix</h2>
      <div class="row">
        <button id="btnMatrix">Refresh Matrix</button>
      </div>
      <div id="matrixTable" style="margin-top:8px"></div>
     <button id="btnDownloadCSV" style="display:none">‚¨áÔ∏è Download CSV</button>
</div>
<div id="matrixTable" style="margin-top:8px"></div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h2>Aggregate Supplies</h2>
        <div class="row">
          <button id="btnAgg">View Aggregates</button>
        </div>
        <div id="aggTable" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="foot">Tip: if you see a revert, open the browser console for more detail.</div>
</div>

<script>
/** =======================
 *  CONFIG
 *  ======================= */
const CONTRACT_ADDRESS = "0xa0df09A1E7Fd6b629FD96a062359E0e42B970289";//1 sept-lapi
const EXPECTED_CHAIN_ID = "11155111";

const ABI = [
  "function owner() view returns (address)",
  "function admin() view returns (address)",
  "function resourceFormOpen() view returns (bool)",
  "function viewMyResourcesWithFlags() view returns (string[] resourceNames, uint256[] quantities, string[] flags)",
  "function Chk_Compliance() view returns (string)",
  "function viewSupplierResourceDetails(uint256 providerId) view returns (string providerName, string[] resourceTypes, uint256[] quantities, string[] flags)",
  "function viewSuppliersByResourceType(uint8 _resourceType) view returns (uint256[] providerIds, string[] providerNames, uint256[] quantities, string[] flags)",
  "function viewSupplierMatrix() view returns (uint256[] providerIds, string[] providerNames, string[] resourceTypeList, uint256[][] quantityMatrix, string[][] flagMatrix, string[][] lastUpdatedMatrix)",
  "function viewAggregateSupplies() view returns (string[] resourceTypes, uint256[] totalSupplies)",
  "function openResourceForm()",
  "function closeResourceForm()",
  "function setResourceQuantity(uint8 _resourceType, uint256 _quantity)",
  "function updateResourceQuantity(uint8 _resourceType, uint256 _quantity)"
];

let provider, signer, contract, myAddr, adminAddr, ownerAddr;

const els = {
  btnConnect: document.getElementById("btnConnect"),
  btnCheckRole: document.getElementById("btnCheckRole"),
  whoami: document.getElementById("whoami"),
  network: document.getElementById("network"),
  formState: document.getElementById("formState"),
  status: document.getElementById("statusBox"),
  btnMyRes: document.getElementById("btnMyRes"),
  myResTable: document.getElementById("myResTable"),
  btnChkCompliance: document.getElementById("btnChkCompliance"),
  complianceBox: document.getElementById("complianceBox"),
  setResType: document.getElementById("setResType"),
  setQty: document.getElementById("setQty"),
  btnSet: document.getElementById("btnSet"),
  updResType: document.getElementById("updResType"),
  updQty: document.getElementById("updQty"),
  btnUpdate: document.getElementById("btnUpdate"),
  btnOpen: document.getElementById("btnOpen"),
  btnClose: document.getElementById("btnClose"),
  viewId: document.getElementById("viewId"),
  btnViewById: document.getElementById("btnViewById"),
  viewByIdTable: document.getElementById("viewByIdTable"),
  byType: document.getElementById("byType"),
  btnByType: document.getElementById("btnByType"),
  byTypeTable: document.getElementById("byTypeTable"),
  btnMatrix: document.getElementById("btnMatrix"),
  matrixTable: document.getElementById("matrixTable"),
  btnDownloadCSV: document.getElementById("btnDownloadCSV"),
  btnAgg: document.getElementById("btnAgg"),
  aggTable: document.getElementById("aggTable"),
  adminSection: document.getElementById("adminSection")
};

function setStatus(msg, isErr=false) {
  els.status.textContent = msg || "";
  els.status.style.color = isErr ? "#fecaca" : "#cbd5e1";
}
function fmtTs(ts) {
  if (!ts || ts === "-" || ts === "0") return "-";
  const d = new Date(Number(ts) * 1000);
  if (isNaN(d.getTime())) {
    // sometimes the contract already returns a string; just return it
    return String(ts);
  }
  return d.toLocaleString();
}

function resNameFromIdx(i) {
  return ["Water","Food","Medical","Cloths"][Number(i)] || `#${i}`;
}

async function connect() {
  try {
    if (!window.ethereum) { setStatus("No wallet found. Install MetaMask.", true); return; }
    await window.ethereum.request({ method: "eth_requestAccounts" });

    provider = new ethers.BrowserProvider(window.ethereum);
    const net = await provider.getNetwork();
    signer = await provider.getSigner();
    myAddr = await signer.getAddress();
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    ownerAddr = await contract.owner();
    adminAddr = await contract.admin();

    els.whoami.textContent = `Connected: ${myAddr}`;
    els.network.textContent = `Network: 0x${net.chainId.toString(16)} | Owner: ${ownerAddr} | Admin: ${adminAddr}`;
    await refreshFormState();

    // üîπ Show admin UI only for owner/admin
    if (myAddr.toLowerCase() === ownerAddr.toLowerCase() || myAddr.toLowerCase() === adminAddr.toLowerCase()) {
      els.adminSection.style.display = "block";
    } else {
      els.adminSection.style.display = "none";
    }

    setStatus("Connected.");
  } catch (e) {
    console.error(e);
    setStatus(e.message, true);
  }
}

async function refreshFormState() {
  try {
    if (!contract) return;
    const open = await contract.resourceFormOpen();
    els.formState.textContent = `Resource Form: ${open ? "OPEN ‚úÖ" : "CLOSED ‚õî"}`;
  } catch (e) {
    console.error(e);
    setStatus(e.message, true);
  }
}
function readableError(err) {
  // ethers v6: err.shortMessage/err.info?.error?.message may contain revert
  return (err?.shortMessage || err?.info?.error?.message || err?.message || String(err))
    .replace("execution reverted: ", "")
    .replace("VM Exception while processing transaction: reverted with reason string ", "");
}

/** ========== My Resources & Compliance ========== */
async function viewMyResources() {
  try {
    const [names, qtys, flags] = await contract.viewMyResourcesWithFlags();
    if (!names.length) {
      els.myResTable.innerHTML = `<div class="hint">No registered resources found for this wallet.</div>`;
      return;
    }
    let rows = names.map((n,i)=>`
      <tr>
        <td>${n}</td>
        <td>${qtys[i]}</td>
        <td>${flags[i] || "-"}</td>
      </tr>`).join("");
    els.myResTable.innerHTML = `
      <table>
        <thead><tr><th>Resource</th><th>Quantity</th><th>Flag</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  } catch (e) {

    console.error(e);
    setStatus(readableError(e), true);
  }
}

async function checkCompliance() {
  try {
    const s = await contract.Chk_Compliance();
    els.complianceBox.textContent = s || "(no output)";
  } catch (e) {
    console.error(e);
    els.complianceBox.textContent = readableError(e);
  }
}

/** ========== Set / Update ========== */
async function setQuantity() {
  try {
    const typeIdx = Number(els.setResType.value);
    const qty = BigInt(els.setQty.value || "0");

    const tx = await contract.setResourceQuantity(typeIdx, qty);
    setStatus("Setting resource quantity... waiting for confirmation");
    await tx.wait();
    setStatus("‚úÖ Quantity set.");
    await viewMyResources();
  } catch (e) {
    console.error(e);
    setStatus(readableError(e), true);
  }
}

async function updateQuantity() {
  try {
    const typeIdx = Number(els.updResType.value);
    const qty = BigInt(els.updQty.value || "0");

    const tx = await contract.updateResourceQuantity(typeIdx, qty);
    setStatus("Updating resource quantity... waiting for confirmation");
    await tx.wait();
    setStatus("‚úÖ Quantity updated.");
    await viewMyResources();
  } catch (e) {
    console.error(e);
    setStatus(readableError(e), true);
  }
}

/** ========== Admin / Owner ========== */
async function openForm() {
  try {
    const tx = await contract.openResourceForm();
    setStatus("Opening form...");
    await tx.wait();
    await refreshFormState();
    setStatus("‚úÖ Form opened.");
  } catch (e) {
    console.error(e);
    setStatus(readableError(e), true);
  }
}

async function closeForm() {
  try {
    const tx = await contract.closeResourceForm();
    setStatus("Closing form...");
    await tx.wait();
    await refreshFormState();
    setStatus("‚úÖ Form closed.");
  } catch (e) {
    console.error(e);
    setStatus(readableError(e), true);
  }
}

async function viewSupplierById() {
  try {
    const id = Number(els.viewId.value);
    if (!id) { setStatus("Enter a supplier id", true); return; }
    const [name, rTypes, qtys, flags] = await contract.viewSupplierResourceDetails(id);

    let rows = rTypes.map((t,i)=>`
      <tr>
        <td>${t}</td>
        <td>${qtys[i]}</td>
        <td>${flags[i] || "-"}</td>
      </tr>`).join("");

    els.viewByIdTable.innerHTML = `
      <div class="hint">Supplier Name: <b>${name}</b></div>
      <table>
        <thead><tr><th>Resource</th><th>Quantity</th><th>Flag</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  } catch (e) {
    console.error(e);
    els.viewByIdTable.innerHTML = "";
    setStatus(readableError(e), true);
  }
}

async function viewByResourceType() {
  try {
    const idx = Number(els.byType.value);
    const [ids, names, qtys, flags] = await contract.viewSuppliersByResourceType(idx);
    if (!ids.length) {
      els.byTypeTable.innerHTML = `<div class="hint">No suppliers found for ${resNameFromIdx(idx)}.</div>`;
      return;
    }
    let rows = ids.map((id,i)=>`
      <tr>
        <td>${id}</td>
        <td>${names[i]}</td>
        <td>${qtys[i]}</td>
        <td>${flags[i] || "-"}</td>
      </tr>`).join("");
    els.byTypeTable.innerHTML = `
      <table>
        <thead><tr><th>Supplier ID</th><th>Name</th><th>Quantity</th><th>Flag</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  } catch (e) {
    console.error(e);
    els.byTypeTable.innerHTML = "";
    setStatus(readableError(e), true);
  }
}

async function viewMatrix() {
  try {
    const [ids, names, typeList, qtyMx, flagMx, updMx] = await contract.viewSupplierMatrix();
    if (!ids.length) {
      els.matrixTable.innerHTML = `<div class="hint">No suppliers yet.</div>`;
      document.getElementById("btnDownloadCSV").style.display = "none";
      return;
    }

    // üîπ Resource type header row
    const resHeader = typeList.map(t=>`<th>${t}</th>`).join("");

    // üîπ Build HTML rows + CSV rows
    let csvRows = [];
    csvRows.push(["SupplierID","Name","Row", ...typeList]); // header

    const rows = ids.map((id, i) => {
      const qtyRow = (qtyMx[i] || []).map((q)=>`${q}`);
      const flagRow = (flagMx[i] || []).map((f)=>`${f}`);
      const updRow = (updMx[i] || []).map((ts)=>fmtTs(ts));

      // push into CSV
      csvRows.push([id, names[i], "Qty", ...qtyRow]);
      csvRows.push([id, names[i], "Flag", ...flagRow]);
      csvRows.push([id, names[i], "Updated", ...updRow]);

      return `
        <tr><td rowspan="3">${id}</td><td rowspan="3">${names[i]}</td><td><b>Qty</b></td><td>${qtyRow.join("</td><td>")}</td></tr>
        <tr><td><b>Flag</b></td><td>${flagRow.join("</td><td>")}</td></tr>
        <tr><td><b>Updated</b></td><td>${updRow.join("</td><td>")}</td></tr>
      `;
    }).join("");

    els.matrixTable.innerHTML = `
      <table>
        <thead>
          <tr>
            <th rowspan="2">Supplier ID</th>
            <th rowspan="2">Name</th>
            <th>Row</th>${resHeader ? `<th colspan="${typeList.length}">Resources</th>`:""}
          </tr>
          <tr><th></th>${typeList.map(t=>`<th>${t}</th>`).join("")}</tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;

    // üîπ Save CSV to button dataset
    const csvContent = csvRows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const dlBtn = document.getElementById("btnDownloadCSV");
    dlBtn.style.display = "inline-block";
    dlBtn.onclick = () => {
      const a = document.createElement("a");
      a.href = url;
      a.download = "supplier_matrix.csv";
      a.click();
      URL.revokeObjectURL(url);
    };

  } catch (e) {
    console.error(e);
    els.matrixTable.innerHTML = "";
    document.getElementById("btnDownloadCSV").style.display = "none";
    setStatus(readableError(e), true);
  }
}

async function viewAggregates() {
  try {
    const [types, totals] = await contract.viewAggregateSupplies();
    if (!types.length) {
      els.aggTable.innerHTML = `<div class="hint">No aggregate data.</div>`;
      return;
    }
    let rows = types.map((t,i)=>`
      <tr>
        <td>${t}</td>
        <td>${totals[i]}</td>
      </tr>
    `).join("");
    els.aggTable.innerHTML = `
      <table>
        <thead><tr><th>Resource</th><th>Total Quantity</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  } catch (e) {
    console.error(e);
    els.aggTable.innerHTML = "";
    setStatus(readableError(e), true);
  }
}

/** ========== Bind UI ========== */
els.btnConnect.onclick = connect;
els.btnCheckRole.onclick = async () => {
  try {
    if (!contract) { setStatus("Connect wallet first.", true); return; }
    const me = myAddr || await signer.getAddress();
    const [own, adm] = [ownerAddr || await contract.owner(), adminAddr || await contract.admin()];
    const isOwner = me.toLowerCase() === own.toLowerCase();
    const isAdmin = me.toLowerCase() === adm.toLowerCase();
    setStatus(`You are${isOwner?" OWNER":""}${isAdmin?" ADMIN":(!isOwner && !isAdmin ? " neither owner nor admin" : "")}.`);
  } catch (e) {
    console.error(e);
    setStatus(readableError(e), true);
  }
};

els.btnMyRes.onclick = viewMyResources;
els.btnChkCompliance.onclick = checkCompliance;

els.btnSet.onclick = setQuantity;
els.btnUpdate.onclick = updateQuantity;

els.btnOpen.onclick = openForm;
els.btnClose.onclick = closeForm;

els.btnViewById.onclick = viewSupplierById;
els.btnByType.onclick = viewByResourceType;
els.btnMatrix.onclick = viewMatrix;
els.btnAgg.onclick = viewAggregates;
  els.btnConnect.onclick = connect;
</script>
</body>
</html>









